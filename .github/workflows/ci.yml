name: CI

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*.*.*'
    paths:
      - '**/*.cs'
      - 'manifest.json'
      - 'Pack.ps1'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-package:
    runs-on: windows-latest
    env:
      DOTNET_VERSION: '6.0.x'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore "Small Corner Map.csproj"

      - name: Build Mono
        run: dotnet build "Small Corner Map.csproj" -c Mono --no-restore

      - name: Build IL2CPP
        run: dotnet build "Small Corner Map.csproj" -c IL2CPP --no-restore

      - name: Verify version consistency
        shell: pwsh
        run: |
          $constVersion = (Get-Content Helpers/Constants.cs | Select-String -Pattern 'ModVersion = "([0-9]+\.[0-9]+\.[0-9]+)"').Matches[0].Groups[1].Value
          $manifestVersion = (Get-Content manifest.json | ConvertFrom-Json).version_number
          $csprojVersion = (Get-Content 'Small Corner Map.csproj' | Select-String -Pattern '<AssemblyVersion>([0-9]+\.[0-9]+\.[0-9]+)\.').Matches[0].Groups[1].Value
          Write-Host "Constants: $constVersion Manifest: $manifestVersion Csproj: $csprojVersion"
          if ($constVersion -ne $manifestVersion -or $constVersion -ne $csprojVersion) { Write-Error 'Version mismatch detected. Please sync Constants.ModVersion, manifest.json version_number, and AssemblyVersion/FileVersion.' }

      - name: Package (zip)
        shell: pwsh
        run: pwsh -File Pack.ps1

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SmallCornerMap-build
          path: |
            bin/Mono/netstandard2.1/Small_Corner_Map.Mono.dll
            bin/IL2CPP/net6.0/Small_Corner_Map.Il2cpp.dll
            dist/SmallCornerMap-*.zip

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build-and-package
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: SmallCornerMap-build

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            SmallCornerMap-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Optional: Add a step later to push to Thunderstore via CLI if supported (placeholder)
      # - name: Publish to Thunderstore
      #   run: echo "Integrate Thunderstore publish here when API/CLI available"

